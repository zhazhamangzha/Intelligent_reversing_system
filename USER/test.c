/************************************************************
 * ??????IRS
 * ?????
 * PA????J3
 * PB????J3
 * PD?LCDJ2
 * PE????J2
*************************************************************/

#include "CONFIG.H"	 	 

#define CSB_TX PCout(8)         // PC8 ??????????????????? 
#define BEEN   PCout(10)				// ?????????????????

//
u16 force=0,start=0;//??????force??????????sw
u16 time=0,speed=0,alpha=901;//time???????????speed?????alpha?????
u8 spd[7]={0},i,showforce[6];      //use to show speed
u32   status=0,val,real_time;						      // ???????????????????????
char  s2[10], s1[10];						// LCD????????????????
float	dis;                      // ???????????
u8    ShowDistance[7] = { 0 };				// ?????????????????????


//????????????
void PWM_Speed_Control(void);//?????????????
void tran(void); 					      // ?????????????????????
void Displayspd(void);      //??????
void DisplayDis(float value);       //??????
void Display_force(void);  //?????????

int main(void)
{
	//???????
 	Stm32_Clock_Init(9);  //????????????
	delay_init(72);	      //???????????
	uart_init(72,9600);   //??????????? 
	PWM_Init(900,0);      //??????????PWM????=72000/900=80Khz
	EXTIX_Init();         //????????????
	Adc_Init();           //ADC start
	Init_12864();         // ???????????
	Timer3_Init(500,7199);//10Khz?????????????????????500?50ms  
    Timer4_Init(10, 71);  // 1Mhz?????????????????????10?10us  
	LED_Init();

    Display_string(0,0,"智能倒车系统");
  	while(1)
	{
 		delay_ms(10);

		start=(GPIOB->IDR&0x0100)>>7;//????
	    /******************??????****************/		
		//Display_string(0,0,"??????");
		if(start) Display_string(7,0,"?");
			else Display_string(7,0,"?");
			
		if(start)
		{
			tran();		//????????????
			PWM_Speed_Control();

			//when distanse belows to 3,warning!
			if (dis<10&&dis!=0) BEEN=1;
			else BEEN=0;		
			if (dis>80) dis=80;		


			
			Displayspd();
			DisplayDis(dis*10);
			Display_force();
		}

	}
}

// ?????????????????????
void tran(void)
{
	u8 i;
	TIM4->CR1 |= 0x01;         // ?????????3
	TIM4->SR &= ~(1 << 0);       // ????????????3???????    
	status = 0;			       // ?????????????????????????????
	for (i = 0; i < 8; i++)         // ??????????????????????????????41.67kHz
	{
		CSB_TX = 1;
		delay_us(12);
		CSB_TX = 0;
		delay_us(12);
	}
	delay_ms(10);
}

void PWM_Speed_Control(void)
{
	if(dis<10) alpha=901;
	else if(dis>30)//????????????
	{
		alpha=200;
	}
	else
	{
		alpha=-35*dis+700;//change number to control the distense
	}
	LED0_PWM_VAL=alpha;
}

void Displayspd(void)
{
	Display_string(0,1,"??");
	spd[0]=speed/100+0x30;           //????
	spd[1]=(speed/10)%10+0x30;
	spd[2]=speed%10+0x30;
	spd[3]='r';
	spd[4]='/';
	spd[5]='s';
	Display_string(5,1,spd);
}

void DisplayDis(float value)
{
	Display_string(0,2,"??");
    val=(u32)value;
    ShowDistance[0] = (val/100)+48;
    ShowDistance[1] = (val%100)/10+48;
	ShowDistance[2] = '.';
    ShowDistance[3] = val%10+48;
    ShowDistance[4] = 'c';
    ShowDistance[5] = 'm';
	Display_string(5,2,ShowDistance);
}

void Display_force()
{
	Display_string(0,3,"?????"); 
	showforce[0] = force/1000+'0';
	showforce[1] = (force/100)%10+'0';
	showforce[2] = (force/10)%10+'0';
	showforce[3] = (force%10)+'0';
	showforce[4] = 'N';
	Display_string(5,3,showforce);
}
